# Sample PSQL Astrolabe controller

This project contains a sample controller for taking snapshots of Postgres instances provisioned using the [Zalando operator](https://github.com/zalando/postgres-operator). This controller was created using the Kubebuilder framework.

The following describes the contents of each directory:

- api
  - This contains the type definitions for the `PSQLSnapshot` and `PSQLRestore` types (modelled after the CSI VolumeSnapshot types)
- bin
  - The build process using make will place binary files here
- config
  - This contains the generated CRD files and other files generated by Kubebuilder.
  - Important directories:
    - config/crd/bases/ - These are the YAML CRD definitions
    - config/samples/ - These are sample instances of the CRDs which can be applied to the cluster
- contollers
  - This contains the controller implementations
- hack
  - Files used by Kubebuilder


## Building Prerequisites

To build the project, it is necessary to check out the following projects in your GOPATH:

- github.com/vmware-tanzu/astrolabe
  - Check out branch https://github.com/dsu-igeek/astrolabe/tree/dsu-localsnap-01-07-2022
- github.com/vmware-tanzu/velero
- github.com/dsu-igeek/astrolabe-kopia
- github.com/kopia/kopia
- github.com/dsu-igeek/astrolabe-demo
- github.com/vmware-tanzu/velero-plugin-for-aws
- github.com/vmware-tanzu/velero-plugin-for-vsphere
- github.com/vmware-tanzu/astrolabe-velero
  - Note: this repo was fetched from https://github.com/dsu-igeek/astrolabe-velero but locally I have this checked out under $GOPATH/src/github.com/vmware-tanzu
- github.com/zalando/postgres-operator

## Build instructions

To build, run the following:

- make manfiests
- make generate
- make

## Run instructions

It is necessary to define Astrolabe configuration files for running this demo project.
Sample configuration for running locally can be found in `local_astrolabe_conf` in this directory.
The configuration file `local_astrolabe_conf/pes/psql.pe.json` defines where the PSQL snapshots should be stored.
Set the `snapshotsDir` value to a path on your local machine where the snapshots should be stored.

It is necessary to include the VDDK libraries in the LD_LIBRARY_PATH when running.
These are stored elsewhere in the repository.

Run the project as follows from this directory:

```
LD_LIBRARY_PATH=../../docker/astrolabe-controller/overrides/usr/local/vmware-vix-disklib-distrib/lib64 bin/manager -confDir local_astrolabe_conf
```

This will start the controller binary locally using the default Kube config.

## Interacting with the controller

This controller will snapshot Zalando Postgres instances. The Zalando Postgres operator repo includes instructions to set up a sample instance.

Install the CRDs in your local cluster by using `kubectl` to apply the CRDs under config/crd/bases/.

Then apply a sample snapshot CRD (found under config/samples).

Once the snapshot process finishes, the PSQL snapshot contents will be available in the directory specified in `local_astrolabe_conf/pes/psql.pe.json`.
